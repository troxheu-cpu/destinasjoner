<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oppdag Norge – Full Versjon</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1623;
      --line: rgba(255, 255, 255, .10);
      --text: #e7eef8;
      --primary: #22c55e;
    }

    body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: sans-serif; }
    
    /* Paywall som faktisk forsvinner helt */
    #authPage {
      position: fixed; inset: 0; z-index: 9999;
      background: #000; display: flex; align-items: center; justify-content: center;
    }

    .app-container { display: flex; height: 100vh; width: 100vw; display: none; }
    
    .sidebar { 
      width: 400px; background: var(--panel); border-right: 1px solid var(--line);
      display: flex; flex-direction: column; z-index: 10;
    }

    #map { flex: 1; height: 100%; width: 100%; background: #000; }

    .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    .btn-vipps { background: #ff5b24; color: white; margin: 10px; width: 200px; }
    
    .list-item { padding: 15px; border-bottom: 1px solid var(--line); }
    
    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--panel); padding: 20px; border-radius: 15px; display: none; z-index: 10000;
      border: 1px solid var(--line); width: 400px;
    }
  </style>
</head>
<body>

<div id="authPage">
  <div style="text-align: center;">
    <h1>Lås opp Kartet</h1>
    <button class="btn btn-vipps" onclick="startApp()">Betal med Vipps (Demo)</button>
  </div>
</div>

<div class="app-container" id="mainApp">
  <aside class="sidebar">
    <div style="padding: 20px;">
      <h2>Dashbord</h2>
      <button class="btn" style="background: var(--primary); width: 100%;" onclick="openModal()">+ Legg til sted</button>
    </div>
    <div id="placeList" style="overflow-y: auto; flex: 1;"></div>
  </aside>
  <div id="map"></div>
</div>

<div id="addModal" class="modal">
  <h3>Ny destinasjon</h3>
  <p id="hint" style="color: #3b82f6; font-size: 12px;">1. Klikk på kartet for posisjon</p>
  <input id="title" placeholder="Navn på sted" style="width:100%; margin: 10px 0; padding: 10px; background: #000; color: #fff; border: 1px solid #444;">
  <button class="btn" style="background: var(--primary); width: 100%;" onclick="saveData()">Lagre</button>
  <button class="btn" style="margin-top: 10px; width: 100%;" onclick="closeModal()">Avbryt</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map, selectedCoords, markers = [];
  const userID = "user_" + Math.random().toString(36).substring(7);

  function startApp() {
    document.getElementById('authPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    
    // Viktig: Initialiser kartet ETTER at containeren er display: flex
    setTimeout(() => {
      initMap();
    }, 100);
  }

  function initMap() {
    if (map) return;
    
    map = L.map('map').setView([61, 9], 6);
    
    // Bruker en mer stabil kartkilde
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Tving kartet til å fylle hele skjermen korrekt
    map.invalidateSize();

    map.on('click', function(e) {
      if(document.getElementById('addModal').style.display === 'block') {
        selectedCoords = e.latlng;
        document.getElementById('hint').innerText = "Posisjon valgt: " + e.latlng.lat.toFixed(3);
        
        // Legg til en midlertidig markør
        L.marker(e.latlng).addTo(map).clearAllEventListeners;
      }
    });
  }

  function openModal() {
    document.getElementById('addModal').style.display = 'block';
    selectedCoords = null;
    document.getElementById('hint').innerText = "1. Klikk på kartet for posisjon";
  }

  function closeModal() {
    document.getElementById('addModal').style.display = 'none';
  }

  function saveData() {
    if(!selectedCoords) {
      alert("Du må klikke på kartet for å velge et sted først!");
      return;
    }
    
    const title = document.getElementById('title').value;
    const newPlace = { title, lat: selectedCoords.lat, lng: selectedCoords.lng, owner: userID };
    
    let saved = JSON.parse(localStorage.getItem('myPlaces') || "[]");
    saved.push(newPlace);
    localStorage.setItem('myPlaces', JSON.stringify(saved));
    
    renderList();
    closeModal();
    L.marker([newPlace.lat, newPlace.lng]).addTo(map).bindPopup(newPlace.title);
  }

  function renderList() {
    const list = document.getElementById('placeList');
    list.innerHTML = '';
    const saved = JSON.parse(localStorage.getItem('myPlaces') || "[]");
    
    saved.forEach(p => {
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `<strong>${p.title}</strong><br><small>Din destinasjon</small>`;
      item.onclick = () => map.flyTo([p.lat, p.lng], 12);
      list.appendChild(item);
    });
  }
</script>
</body>
</html>
