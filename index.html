<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oppdag Norge ‚Äì Pro Versjon</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1623;
      --panel2: #111826;
      --line: rgba(255, 255, 255, .10);
      --text: #e7eef8;
      --muted: rgba(231, 238, 248, .75);
      --ok: #22c55e;
      --bad: #ef4444;
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body, html { height: 100%; margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

    /* App Layout */
    .app { display: none; height: 100vh; width: 100vw; }
    .side { width: 410px; border-right: 1px solid var(--line); display: flex; flex-direction: column; background: var(--panel); overflow: hidden; }
    #map { flex: 1; background: #000; cursor: crosshair; }

    /* UI Elements */
    .topbar { padding: 15px; border-bottom: 1px solid var(--line); display: flex; align-items: center; justify-content: space-between; }
    .btn { padding: 10px 15px; border-radius: 12px; border: 1px solid var(--line); background: var(--panel2); color: white; cursor: pointer; font-weight: bold; }
    .btn.primary { background: rgba(34, 197, 94, 0.2); border-color: var(--ok); }
    
    .list { flex: 1; overflow-y: auto; padding: 15px; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
    .card:hover { border-color: var(--ok); background: rgba(255,255,255,0.05); }

    /* Modal - Fikset for √• tillate klikk p√• kartet */
    .overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
      display: none; align-items: center; justify-content: center; z-index: 2000; 
    }
    .modal { 
      width: 450px; background: var(--panel); border-radius: 20px; padding: 25px; 
      border: 1px solid var(--line); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    
    input, select, textarea { 
      width: 100%; padding: 12px; margin: 8px 0; background: #080c14; 
      border: 1px solid var(--line); border-radius: 10px; color: white; 
    }

    /* Paywall */
    .paywall { position: fixed; inset: 0; z-index: 3000; background: var(--bg); display: flex; align-items: center; justify-content: center; text-align: center; }
    .pay-card { padding: 40px; border: 1px solid var(--line); border-radius: 24px; background: var(--panel); max-width: 400px; }

    .thumb { width: 100%; border-radius: 8px; margin-top: 10px; }
    .badge { font-size: 11px; background: var(--line); padding: 3px 8px; border-radius: 5px; margin-right: 5px; }
  </style>
</head>
<body>

<div id="paywall" class="paywall">
  <div class="pay-card">
    <h1>üá≥üá¥ Norge Reise</h1>
    <p>Utforsk skjulte perler og legg til dine egne favoritter.</p>
    <button class="btn primary" style="width:100%; margin-top:20px;" onclick="unlock(true)">G√• til Kartet (Admin)</button>
  </div>
</div>

<div class="app" id="app">
  <aside class="side">
    <div class="topbar">
      <div>
        <h2 style="margin:0; font-size:18px;">Oppdag Norge</h2>
        <small style="color:var(--muted)">Dine destinasjoner</small>
      </div>
      <button class="btn primary" onclick="openModal()">+ Ny</button>
    </div>
    
    <div style="padding:15px; border-bottom:1px solid var(--line);">
      <input type="text" id="search" placeholder="S√∏k i dine steder..." oninput="render()">
    </div>

    <div class="list" id="list"></div>
  </aside>
  <div id="map"></div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2 style="margin-top:0">Legg til sted</h2>
    <div id="coordsStatus" style="color:var(--ok); font-weight:bold; font-size:13px; margin-bottom:10px;">
      üìç 1. Klikk p√• kartet for √• velge punkt
    </div>
    <input id="f_name" placeholder="Navn (f.eks. Gaustatoppen)">
    <select id="f_cat">
      <option value="natur">Natur</option>
      <option value="utsikt">Utsikt</option>
      <option value="kultur">Kultur</option>
    </select>
    <textarea id="f_desc" placeholder="Kort beskrivelse..."></textarea>
    <input id="f_img" placeholder="Bilde-URL (valgfritt)">
    
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button class="btn" style="flex:1" onclick="closeModal()">Avbryt</button>
      <button class="btn primary" style="flex:1" onclick="savePlace()">Lagre Sted</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map, markers = [], pendingLatLng = null, tempMarker = null;
  
  // Last inn fra localStorage eller bruk standard
  let steder = JSON.parse(localStorage.getItem('norge_steder')) || [
    { id: 1, title: "Bryggen", cat: "kultur", desc: "Historisk i Bergen", lat: 60.397, lng: 5.324, img: "" }
  ];

  function unlock(admin) {
    document.getElementById('paywall').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    // Initialiser kartet umiddelbart etter display:flex
    setTimeout(() => {
      initMap();
      render();
    }, 50);
  }

  function initMap() {
    if (map) return;
    map = L.map('map', { zoomControl: false }).setView([62, 10], 5);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Tving kartet til √• forst√• sin nye st√∏rrelse
    map.invalidateSize();

    map.on('click', (e) => {
      if (document.getElementById('overlay').style.display === 'flex') {
        pendingLatLng = e.latlng;
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng).addTo(map);
        document.getElementById('coordsStatus').innerText = "‚úÖ Punkt valgt!";
      }
    });
  }

  function render() {
    const listEl = document.getElementById('list');
    const search = document.getElementById('search').value.toLowerCase();
    listEl.innerHTML = '';
    
    // Rens kartet for gamle mark√∏rer
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const filtrert = steder.filter(s => s.title.toLowerCase().includes(search));

    filtrert.forEach(s => {
      // Legg til p√• kart
      const m = L.marker([s.lat, s.lng]).addTo(map)
        .bindPopup(`<b>${s.title}</b><br>${s.desc}`);
      markers.push(m);

      // Legg til i listen
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="font-weight:bold">${s.title}</div>
        <div><span class="badge">${s.cat}</span></div>
        <div style="font-size:12px; color:var(--muted); margin-top:5px;">${s.desc}</div>
        ${s.img ? `<img src="${s.img}" class="thumb">` : ''}
      `;
      card.onclick = () => {
        map.flyTo([s.lat, s.lng], 12);
        m.openPopup();
      };
      listEl.appendChild(card);
    });
  }

  function openModal() {
    document.getElementById('overlay').style.display = 'flex';
    pendingLatLng = null;
    document.getElementById('coordsStatus').innerText = "üìç 1. Klikk p√• kartet for √• velge punkt";
    // Gj√∏r overlay "gjennomsiktig" for klikk slik at man kan treffe kartet bak
    document.getElementById('overlay').style.pointerEvents = 'none';
    document.querySelector('.modal').style.pointerEvents = 'auto';
  }

  function closeModal() {
    document.getElementById('overlay').style.display = 'none';
    if (tempMarker) map.removeLayer(tempMarker);
    document.getElementById('overlay').style.pointerEvents = 'auto';
  }

  function savePlace() {
    const name = document.getElementById('f_name').value;
    if (!name || !pendingLatLng) return alert("Du m√• gi et navn og velge et punkt p√• kartet!");

    const ny = {
      id: Date.now(),
      title: name,
      cat: document.getElementById('f_cat').value,
      desc: document.getElementById('f_desc').value,
      img: document.getElementById('f_img').value,
      lat: pendingLatLng.lat,
      lng: pendingLatLng.lng
    };

    steder.unshift(ny);
    localStorage.setItem('norge_steder', JSON.stringify(steder));
    
    closeModal();
    render();
    map.flyTo([ny.lat, ny.lng], 10);
  }
</script>
</body>
</html>
