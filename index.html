<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oppdag Norge – Destinasjoner</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1623;
      --panel2:#111826;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --text:#e7eef8;
      --muted:rgba(231,238,248,.75);
      --muted2:rgba(231,238,248,.6);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.08);
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius:16px;
    }

    *{ box-sizing:border-box; }

    /* ✅ Viktig: full høyde */
    html, body { height:100%; }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden; /* hindrer rare scroll/height bugs */
    }

    .app{
      height:100vh;
      width:100vw;
      display:flex;
      overflow:hidden;
    }

    .side{
      width:410px; min-width:320px; max-width:520px;
      border-right:1px solid var(--line);
      padding:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      overflow:auto;
    }

    /* ✅ Viktig: map må ha eksplisitt høyde/bredde */
    #map{
      flex:1;
      height:100vh;
      width:100%;
      background:#0b0f14;
    }

    .topbar{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background: radial-gradient(circle at 30% 30%, rgba(34,197,94,.9), rgba(34,197,94,.25));
      border:1px solid rgba(34,197,94,.35);
      flex:0 0 auto;
    }
    .brand h1{ font-size:15px; margin:0; font-weight:700; }
    .brand .sub{ font-size:12px; opacity:.75; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:210px; }
    .spacer{ flex:1; }

    .btn{
      appearance:none; border:1px solid var(--line2);
      background: var(--panel2); color:var(--text);
      padding:9px 10px; border-radius:12px; cursor:pointer;
      font-weight:700; font-size:12px;
    }
    .btn:hover{ border-color: rgba(255,255,255,.22); }
    .btn.primary{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .btn.primary:hover{ border-color: rgba(34,197,94,.6); }
    .btn.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
    .btn.ghost{ background: transparent; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px; color: var(--muted);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--bad); }
    .dot.on{ background: var(--ok); }

    .controls{ margin-top:12px; border:1px solid var(--line); border-radius: var(--radius); background: var(--panel); padding:12px; }
    .row{ display:flex; gap:8px; }
    .row + .row{ margin-top:8px; }

    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: #0c1320;
      color: var(--text);
      outline:none;
      font-size:13px;
    }
    input::placeholder, textarea::placeholder{ color: var(--muted2); }
    textarea{ min-height: 84px; resize: vertical; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--text);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{ border-color: rgba(34,197,94,.65); background: rgba(34,197,94,.12); }

    .toggles{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      font-size:12px; color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{ width:auto; }
    .toggle strong{ color:var(--text); font-weight:700; }

    .list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      padding:10px; border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      cursor:pointer;
    }
    .card:hover{ border-color: rgba(255,255,255,.22); }
    .card .title{ font-weight:800; font-size:14px; }
    .card .meta{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
    .badge{
      display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .badge.admin{ border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12); color: #ffd8a8; }
    .card .desc{ margin-top:6px; font-size:12px; color: var(--muted); line-height:1.35; }
    .thumb{ width:100%; border-radius: 12px; margin-top:8px; display:block; border:1px solid var(--line); }

    /* ✅ Modal overlay: lar kart-klikk gå gjennom */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:2000;
      pointer-events:none;
    }
    .modal{ pointer-events:auto; }

    .modal{
      width:min(820px, 98vw);
      max-height: 92vh;
      overflow:auto;
      border:1px solid rgba(255,255,255,.14);
      background: #0c1220;
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .modalHeader{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-bottom: 1px solid var(--line);
      position:sticky; top:0;
      background: rgba(12,18,32,.96);
      backdrop-filter: blur(8px);
    }
    .modalHeader h2{ margin:0; font-size:14px; font-weight:900; }
    .modalHeader .small{ font-size:12px; color: var(--muted); }
    .modalBody{ padding:14px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid .full{ grid-column: 1 / -1; }
    .label{ font-size:12px; color: var(--muted); margin: 2px 0 6px; }
    .help{ font-size:12px; color: var(--muted2); margin-top:6px; }

    .stars{
      display:flex; gap:6px; align-items:center;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--line);
      background:#0c1320;
      height: 40px;
    }
    .star{ font-size:18px; cursor:pointer; user-select:none; opacity:.45; }
    .star.on{ opacity:1; }
    .starVal{ font-size:12px; color: var(--muted); margin-left:8px; }

    .paywall{
      position:fixed; inset:0; z-index:3000;
      background: radial-gradient(circle at 25% 10%, rgba(34,197,94,.18), rgba(0,0,0,0) 45%),
                  radial-gradient(circle at 70% 20%, rgba(245,158,11,.15), rgba(0,0,0,0) 40%),
                  var(--bg);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .payCard{
      width:min(860px, 98vw);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
    }
    .payLeft{ padding:18px; }
    .payRight{ padding:18px; border-left:1px solid rgba(255,255,255,.10); background: rgba(17,24,38,.35); }
    .payTitle{ font-size:22px; font-weight:900; margin:0; }
    .paySub{ margin-top:8px; color:var(--muted); line-height:1.4; }
    .payBullets{ margin-top:12px; color:var(--muted); }
    .payBullets li{ margin:6px 0; }
    .payBox{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:14px;
      background: rgba(12,18,32,.55);
    }
    .payBox h3{ margin:0 0 8px; font-size:14px; }
    .price{ font-size:26px; font-weight:900; margin: 6px 0 6px; }
    .fine{ font-size:12px; color:var(--muted2); line-height:1.4; }
    .sep{ height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .note{ font-size:12px; color:var(--muted2); margin-top:10px; }

    @media (max-width: 900px){
      .app{ flex-direction:column; }
      .side{ width:100%; max-width:none; height:46vh; border-right:none; border-bottom:1px solid var(--line); }
      #map{ height:54vh; }
      .payCard{ grid-template-columns: 1fr; }
      .payRight{ border-left:none; border-top:1px solid rgba(255,255,255,.10); }
    }
  </style>
</head>

<body>

<div id="paywall" class="paywall">
  <div class="payCard">
    <div class="payLeft">
      <div class="brand" style="margin-bottom:10px">
        <div class="logo"></div>
        <div>
          <div style="font-weight:900">Norge Reise</div>
          <div style="font-size:12px; color:var(--muted2)">Oppdag og del de beste reisemålene</div>
        </div>
      </div>

      <h2 class="payTitle">Lås opp kartet (demo)</h2>
      <div class="paySub">Velg modus for å gå inn.</div>
      <ul class="payBullets">
        <li>Legg inn steder med bilde, tips og ⭐ vurdering</li>
        <li>Filter på kategorier</li>
        <li>Alle ser de samme anbefalingene (i demo forsvinner nye steder ved refresh)</li>
      </ul>
    </div>

    <div class="payRight">
      <div class="payBox">
        <h3>Abonnement</h3>
        <div class="price">79 kr / mnd</div>
        <div class="fine">(Demo) Klikk for å gå inn.</div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn warn" id="enterAsAdminBtn">Fortsett som Admin</button>
          <button class="btn primary" id="enterAsUserBtn">Fortsett som Bruker</button>
        </div>

        <div class="note">Admin kan merke “Admin valg”.</div>
      </div>
    </div>
  </div>
</div>

<div class="app" id="app" style="display:none;">
  <aside class="side">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0">
          <h1>Oppdag Norge</h1>
          <div class="sub">Utforsk og del de beste reisemålene</div>
        </div>
      </div>

      <div class="spacer"></div>

      <span class="pill">
        <span id="adminDot" class="dot"></span>
        <span><strong id="modeLabel">Bruker</strong></span>
      </span>

      <button class="btn primary" id="addBtn">+ Legg til</button>
      <button class="btn ghost" id="lockBtn">Lås</button>
    </div>

    <div class="controls">
      <div class="row">
        <input id="q" placeholder="Søk destinasjoner (navn / sted / tips)" />
        <select id="cat">
          <option value="">Alle</option>
          <option value="natur">Natur</option>
          <option value="kultur">Kultur</option>
          <option value="aktiviteter">Aktiviteter</option>
          <option value="mat">Mat</option>
          <option value="overnatting">Overnatting</option>
          <option value="shopping">Shopping</option>
          <option value="utsikt">Utsikt</option>
        </select>
      </div>

      <div class="toggles">
        <label class="toggle">
          <input type="checkbox" id="onlyAdmin" />
          <strong>Kun Admin valg</strong>
        </label>
      </div>

      <div class="chips" id="chips"></div>
      <div class="help" id="tileStatus" style="margin-top:10px;"></div>
    </div>

    <div class="list" id="list"></div>
  </aside>

  <div id="map"></div>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <h2>Legg til ny destinasjon</h2>
        <div class="small" id="modalCoord">Klikk på kartet for å velge plassering</div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="closeModal">✕</button>
    </div>

    <div class="modalBody">
      <div class="grid">
        <div>
          <div class="label">Navn *</div>
          <input id="f_name" placeholder="F.eks. Preikestolen" />
        </div>

        <div>
          <div class="label">Stedsnavn (valgfritt)</div>
          <input id="f_place" placeholder="F.eks. Stavanger, Rogaland" />
        </div>

        <div class="full">
          <div class="label">Beskrivelse *</div>
          <textarea id="f_desc" placeholder="Beskriv destinasjonen..."></textarea>
        </div>

        <div>
          <div class="label">Kategori *</div>
          <select id="f_cat">
            <option value="natur">Natur</option>
            <option value="kultur">Kultur</option>
            <option value="aktiviteter">Aktiviteter</option>
            <option value="mat">Mat</option>
            <option value="overnatting">Overnatting</option>
            <option value="shopping">Shopping</option>
            <option value="utsikt">Utsikt</option>
          </select>
        </div>

        <div>
          <div class="label">Beste sesong *</div>
          <select id="f_season">
            <option value="hele_året">Hele året</option>
            <option value="vår">Vår</option>
            <option value="sommer">Sommer</option>
            <option value="høst">Høst</option>
            <option value="vinter">Vinter</option>
          </select>
        </div>

        <div>
          <div class="label">Vurdering</div>
          <div class="stars" id="stars">
            <span class="star" data-v="1">★</span>
            <span class="star" data-v="2">★</span>
            <span class="star" data-v="3">★</span>
            <span class="star" data-v="4">★</span>
            <span class="star" data-v="5">★</span>
            <span class="starVal" id="starVal">Ikke valgt</span>
          </div>
        </div>

        <div>
          <div class="label">Bilde (valgfritt)</div>
          <input type="file" id="f_file" accept="image/*" />
          <div class="help">Opplasting er lokal preview i demoen.</div>
        </div>

        <div class="full">
          <div class="label">Bilde-URL (valgfritt)</div>
          <input id="f_img" placeholder="https://..." />
        </div>

        <div class="full">
          <div class="label">Tips (valgfritt)</div>
          <textarea id="f_tips" placeholder="Parkering, beste tidspunkt, osv."></textarea>
        </div>

        <div class="full" id="adminPickWrap" style="display:none;">
          <label class="toggle" style="width:fit-content;">
            <input type="checkbox" id="f_adminpick" />
            <strong>Merk som “Admin valg”</strong>
          </label>
        </div>

        <div class="full">
          <div class="row">
            <button class="btn" id="cancelAdd">Avbryt</button>
            <button class="btn primary" id="saveAdd">Lagre</button>
          </div>
          <div class="help" id="saveHelp"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let isUnlocked = false;
  let isAdmin = false;

  const steder = [
    {
      id: crypto.randomUUID(),
      title: "Bryggen",
      place_name: "Bergen",
      description: "Historisk havnefront med fargerike trehus og smale smug.",
      category: "kultur",
      season: "hele_året",
      rating: 5,
      image_url: "https://commons.wikimedia.org/wiki/Special:FilePath/Bryggen%20Bergen.jpg",
      tips: "Best tidlig morgen eller kveld.",
      lat: 60.3971,
      lon: 5.3249,
      is_admin_pick: true
    },
    {
      id: crypto.randomUUID(),
      title: "Ravnåsen utsiktspunkt",
      place_name: "Sandefjord",
      description: "Skogkledd høyde med flott utsikt over Sandefjord og fjorden.",
      category: "utsikt",
      season: "hele_året",
      rating: 4,
      image_url: "",
      tips: "Fin kveldstur med solnedgang.",
      lat: 59.1346,
      lon: 10.2169,
      is_admin_pick: false
    }
  ];

  const CATEGORIES = [
    { key:"natur", label:"Natur" },
    { key:"kultur", label:"Kultur" },
    { key:"aktiviteter", label:"Aktiviteter" },
    { key:"mat", label:"Mat" },
    { key:"overnatting", label:"Overnatting" },
    { key:"shopping", label:"Shopping" },
    { key:"utsikt", label:"Utsikt" }
  ];

  function seasonLabel(v){
    return ({
      "hele_året":"Hele året",
      "vår":"Vår",
      "sommer":"Sommer",
      "høst":"Høst",
      "vinter":"Vinter"
    }[v] || v);
  }
  function starsText(n){
    if(!n) return "";
    const r = Math.round(n);
    return "★★★★★".slice(0,r) + "☆☆☆☆☆".slice(0,5-r);
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Paywall
  const paywallEl = document.getElementById("paywall");
  const appEl = document.getElementById("app");
  const adminDot = document.getElementById("adminDot");
  const modeLabel = document.getElementById("modeLabel");
  const adminPickWrap = document.getElementById("adminPickWrap");

  document.getElementById("enterAsAdminBtn").onclick = () => unlock(true);
  document.getElementById("enterAsUserBtn").onclick = () => unlock(false);
  document.getElementById("lockBtn").onclick = () => {
    isUnlocked = false;
    paywallEl.style.display = "flex";
    appEl.style.display = "none";
  };

  // Map
  const map = L.map("map", { zoomControl:true }).setView([59.20, 10.25], 5);

  const tileStatus = document.getElementById("tileStatus");
  function addTiles(url, label){
    const layer = L.tileLayer(url, { attribution:"© OpenStreetMap" });
    layer.addTo(map);
    tileStatus.textContent = `Kartkilde: ${label}`;
    tileStatus.style.color = "rgba(231,238,248,.75)";

    let err = 0;
    layer.on("tileerror", () => {
      err++;
      if(err >= 3){
        map.removeLayer(layer);
        tileStatus.textContent = "Kartfliser feilet – bytter kartkilde…";
        tileStatus.style.color = "#ffd18a";
        addTiles("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", "OSM Standard");
      }
    });
  }
  addTiles("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", "OSM HOT");

  // ✅ Viktig: tving Leaflet til å beregne størrelse riktig
  function forceMapResize(){
    setTimeout(() => {
      map.invalidateSize(true);
    }, 60);
  }

  function unlock(admin){
    isUnlocked = true;
    isAdmin = admin;
    paywallEl.style.display = "none";
    appEl.style.display = "flex";
    adminDot.classList.toggle("on", isAdmin);
    modeLabel.textContent = isAdmin ? "Admin" : "Bruker";
    adminPickWrap.style.display = isAdmin ? "block" : "none";

    forceMapResize();
    render();
  }

  window.addEventListener("resize", forceMapResize);

  // Markers
  const markers = new Map();
  function popupHtml(d){
    const img = d.image_url ? `<img class="thumb" src="${d.image_url}" alt="">` : "";
    const rating = d.rating ? ` <span style="color:#ffd18a;font-weight:900">${starsText(d.rating)}</span> <span style="opacity:.7">(${d.rating}/5)</span>` : "";
    const admin = d.is_admin_pick ? `<span class="badge admin">Admin valg</span>` : "";
    return `
      <div style="max-width:320px">
        <div style="font-weight:900;font-size:14px">${escapeHtml(d.title)}${rating}</div>
        <div style="margin-top:6px;opacity:.88;line-height:1.35">${escapeHtml(d.description)}</div>
        <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:6px">
          ${admin}
          <span class="badge">${escapeHtml(d.category)}</span>
          <span class="badge">${escapeHtml(seasonLabel(d.season))}</span>
          ${d.place_name ? `<span class="badge">${escapeHtml(d.place_name)}</span>` : ``}
        </div>
        ${img}
        ${d.tips ? `<div style="margin-top:8px;opacity:.9"><em>${escapeHtml(d.tips)}</em></div>` : ``}
      </div>
    `;
  }
  function ensureMarker(d){
    if(markers.has(d.id)) return markers.get(d.id);
    const m = L.marker([d.lat, d.lon]).addTo(map).bindPopup(popupHtml(d));
    markers.set(d.id, m);
    return m;
  }
  function clearMarkers(){
    for(const m of markers.values()) map.removeLayer(m);
    markers.clear();
  }

  // UI filters
  const chipsEl = document.getElementById("chips");
  const listEl = document.getElementById("list");
  const qEl = document.getElementById("q");
  const catEl = document.getElementById("cat");
  const onlyAdminEl = document.getElementById("onlyAdmin");

  let activeChip = "";
  function renderChips(){
    chipsEl.innerHTML = "";
    const all = document.createElement("div");
    all.className = "chip " + (activeChip==="" ? "active" : "");
    all.textContent = "Alle";
    all.onclick = () => { activeChip=""; catEl.value=""; render(); };
    chipsEl.appendChild(all);

    for(const c of CATEGORIES){
      const el = document.createElement("div");
      el.className = "chip " + (activeChip===c.key ? "active" : "");
      el.textContent = c.label;
      el.onclick = () => { activeChip=c.key; catEl.value=c.key; render(); };
      chipsEl.appendChild(el);
    }
  }
  renderChips();

  qEl.addEventListener("input", render);
  catEl.addEventListener("change", () => { activeChip = catEl.value; render(); });
  onlyAdminEl.addEventListener("change", render);

  function filtered(){
    const q = qEl.value.trim().toLowerCase();
    const cat = catEl.value;
    const onlyAdmin = onlyAdminEl.checked;
    return steder.filter(d => {
      const text = `${d.title} ${d.description} ${d.tips||""} ${d.place_name||""}`.toLowerCase();
      return (!q || text.includes(q)) &&
             (!cat || d.category===cat) &&
             (!onlyAdmin || d.is_admin_pick);
    });
  }

  function render(){
    if(!isUnlocked) return;

    renderChips();
    const items = filtered();

    clearMarkers();
    items.forEach(d => ensureMarker(d));

    // Ikke fitBounds aggressivt - behold zoom du setter selv
    // Men hvis ingen view ennå, zoom til Norge-ish:
    if(!items.length){
      map.setView([64.5, 11.0], 4);
    }

    listEl.innerHTML = "";
    items.forEach(d => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="title">${escapeHtml(d.title)}</div>
        <div class="meta">
          ${d.is_admin_pick ? `<span class="badge admin">Admin valg</span>` : ``}
          <span class="badge">${escapeHtml(d.category)}</span>
          <span class="badge">${escapeHtml(seasonLabel(d.season))}</span>
          ${d.place_name ? `<span class="badge">${escapeHtml(d.place_name)}</span>` : ``}
          ${d.rating ? `<span class="badge">⭐ ${d.rating}/5</span>` : ``}
        </div>
        <div class="desc">${escapeHtml(d.description)}</div>
        ${d.image_url ? `<img class="thumb" src="${d.image_url}" alt="">` : ``}
      `;
      card.onclick = () => {
        const m = ensureMarker(d);
        map.setView([d.lat, d.lon], 15);
        m.openPopup();
      };
      listEl.appendChild(card);
    });

    if(!items.length){
      listEl.innerHTML = `<div style="opacity:.75;padding:8px;">Ingen treff.</div>`;
    }

    forceMapResize();
  }

  // Add modal
  const overlay = document.getElementById("overlay");
  const addBtn = document.getElementById("addBtn");
  const closeModalBtn = document.getElementById("closeModal");
  const cancelAddBtn = document.getElementById("cancelAdd");
  const saveAddBtn = document.getElementById("saveAdd");
  const modalCoord = document.getElementById("modalCoord");
  const saveHelp = document.getElementById("saveHelp");

  const f_name = document.getElementById("f_name");
  const f_place = document.getElementById("f_place");
  const f_desc = document.getElementById("f_desc");
  const f_cat = document.getElementById("f_cat");
  const f_season = document.getElementById("f_season");
  const f_img = document.getElementById("f_img");
  const f_tips = document.getElementById("f_tips");
  const f_file = document.getElementById("f_file");
  const f_adminpick = document.getElementById("f_adminpick");

  let pendingLatLng = null;
  let tempPin = null;
  let ratingVal = null;
  let fileObjectUrl = "";

  const stars = Array.from(document.querySelectorAll(".star"));
  const starValEl = document.getElementById("starVal");
  function setRating(v){
    ratingVal = v;
    stars.forEach(s => s.classList.toggle("on", Number(s.dataset.v) <= v));
    starValEl.textContent = v ? `${v}/5` : "Ikke valgt";
  }
  stars.forEach(s => s.addEventListener("click", () => setRating(Number(s.dataset.v))));
  setRating(null);

  function openModal(){
    overlay.style.display = "flex";
    saveHelp.textContent = "";
    forceMapResize();
  }
  function closeModal(){
    overlay.style.display = "none";
    pendingLatLng = null;
    if(tempPin){ map.removeLayer(tempPin); tempPin = null; }
    if(fileObjectUrl){ URL.revokeObjectURL(fileObjectUrl); fileObjectUrl=""; }
    forceMapResize();
  }

  addBtn.onclick = () => {
    f_name.value = "";
    f_place.value = "";
    f_desc.value = "";
    f_cat.value = "natur";
    f_season.value = "hele_året";
    f_img.value = "";
    f_tips.value = "";
    f_file.value = "";
    if(isAdmin) f_adminpick.checked = false;
    setRating(null);

    pendingLatLng = null;
    modalCoord.textContent = "Klikk på kartet for å velge plassering";
    openModal();
  };

  closeModalBtn.onclick = closeModal;
  cancelAddBtn.onclick = closeModal;

  map.on("click", (e) => {
    if(overlay.style.display !== "flex") return;
    pendingLatLng = e.latlng;
    modalCoord.textContent = `Valgt posisjon: ${pendingLatLng.lat.toFixed(5)}, ${pendingLatLng.lng.toFixed(5)}`;
    if(tempPin) map.removeLayer(tempPin);
    tempPin = L.marker([pendingLatLng.lat, pendingLatLng.lng]).addTo(map);
  });

  f_file.addEventListener("change", () => {
    if(fileObjectUrl){ URL.revokeObjectURL(fileObjectUrl); fileObjectUrl=""; }
    const file = f_file.files && f_file.files[0];
    if(file){
      fileObjectUrl = URL.createObjectURL(file);
      f_img.value = fileObjectUrl; // demo preview
    }
  });

  saveAddBtn.onclick = () => {
    saveHelp.style.color = "";
    saveHelp.textContent = "";

    if(!pendingLatLng){
      saveHelp.style.color = "#ffd18a";
      saveHelp.textContent = "Klikk på kartet for å velge plassering før du lagrer.";
      return;
    }
    if(!f_name.value.trim()){
      saveHelp.style.color = "#ffd18a";
      saveHelp.textContent = "Navn er påkrevd.";
      return;
    }
    if(!f_desc.value.trim()){
      saveHelp.style.color = "#ffd18a";
      saveHelp.textContent = "Beskrivelse er påkrevd.";
      return;
    }

    const d = {
      id: crypto.randomUUID(),
      title: f_name.value.trim(),
      place_name: f_place.value.trim(),
      description: f_desc.value.trim(),
      category: f_cat.value,
      season: f_season.value,
      rating: ratingVal ? Number(ratingVal) : null,
      image_url: (f_img.value || "").trim(),
      tips: f_tips.value.trim(),
      lat: pendingLatLng.lat,
      lon: pendingLatLng.lng,
      is_admin_pick: isAdmin ? !!f_adminpick.checked : false
    };

    steder.unshift(d);
    closeModal();
    render();

    const m = ensureMarker(d);
    map.setView([d.lat, d.lon], 15);
    m.openPopup();
  };
</script>
</body>
</html>
