<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Norge Reise - Admin v2</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0b0f14; --panel: #0f1623; --line: rgba(255, 255, 255, .1);
      --text: #e7eef8; --primary: #22c55e; --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    
    .app { display: none; height: 100vh; }
    .sidebar { width: 380px; background: var(--panel); border-right: 1px solid var(--line); display: flex; flex-direction: column; z-index: 1000; }
    #map { flex: 1; z-index: 1; cursor: crosshair; }

    .header { padding: 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
    .list { flex: 1; overflow-y: auto; padding: 12px; }
    
    .card { background: rgba(255,255,255,0.03); border: 1px solid var(--line); padding: 12px; border-radius: 12px; margin-bottom: 10px; }
    .card:hover { border-color: var(--primary); }
    
    .btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--line); cursor: pointer; font-weight: bold; background: var(--panel); color: white; }
    .btn-save { background: var(--primary); color: black; border: none; width: 100%; margin-top: 10px; }
    .btn-del { color: var(--danger); border-color: var(--danger); font-size: 11px; margin-top: 5px; background: transparent; }

    /* Modal fix: Ingen bakgrunnsperre for kartklikk */
    .modal-overlay { position: fixed; top: 20px; right: 20px; width: 340px; background: var(--panel); border: 1px solid var(--line); border-radius: 16px; padding: 20px; z-index: 2000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    
    input, textarea, select { width: 100%; margin-bottom: 10px; padding: 10px; background: #080c14; border: 1px solid var(--line); color: white; border-radius: 6px; }

    #paywall { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 3000; }
  </style>
</head>
<body>

<div id="paywall">
  <button class="btn" style="padding: 20px 40px" onclick="initApp()">LÃ…S OPP DASHBORD</button>
</div>

<div class="app" id="app">
  <aside class="sidebar">
    <div class="header">
      <h2 style="margin:0">Destinasjoner</h2>
      <button class="btn" onclick="toggleModal()">+ Legg til</button>
    </div>
    <div id="list" class="list"></div>
  </aside>
  <div id="map"></div>
</div>

<div id="modal" class="modal-overlay">
  <h3 style="margin-top:0">Nytt sted</h3>
  <p id="coord-status" style="font-size:12px; color:var(--primary)">ðŸ‘‰ Klikk i kartet for koordinater</p>
  <input id="f-title" placeholder="Navn pÃ¥ stedet">
  <textarea id="f-desc" placeholder="Beskrivelse"></textarea>
  <select id="f-cat">
    <option value="Natur">Natur</option>
    <option value="Utsikt">Utsikt</option>
    <option value="Kultur">Kultur</option>
  </select>
  <button class="btn btn-save" onclick="savePlace()">Lagre destinasjon</button>
  <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleModal()">Avbryt</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map, markers = [], selectedLatLng = null, tempMarker = null;
  let steder = JSON.parse(localStorage.getItem('reise_data')) || [];

  function initApp() {
    document.getElementById('paywall').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    map = L.map('map').setView([62, 10], 5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

    map.on('click', (e) => {
      if (document.getElementById('modal').style.display === 'block') {
        selectedLatLng = e.latlng;
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng).addTo(map);
        document.getElementById('coord-status').innerText = `ðŸ“ Valgt: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
      }
    });

    render();
  }

  function render() {
    const listEl = document.getElementById('list');
    listEl.innerHTML = '';
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    steder.forEach((s, index) => {
      // Kart
      const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(`<b>${s.title}</b>`);
      markers.push(m);

      // Liste
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div style="font-weight:bold">${s.title} <span style="font-size:10px; opacity:0.5">${s.cat}</span></div>
        <div style="font-size:12px; margin-top:4px">${s.desc}</div>
        <div style="display:flex; gap:10px; margin-top:8px">
          <button class="btn" style="font-size:11px; padding:4px 8px" onclick="focusPlace(${s.lat}, ${s.lng}, ${index})">Vis</button>
          <button class="btn btn-del" onclick="deletePlace(${index})">Slett</button>
        </div>
      `;
      listEl.appendChild(card);
    });
  }

  function toggleModal() {
    const m = document.getElementById('modal');
    m.style.display = m.style.display === 'block' ? 'none' : 'block';
    selectedLatLng = null;
    if (tempMarker) map.removeLayer(tempMarker);
  }

  function savePlace() {
    const title = document.getElementById('f-title').value;
    const desc = document.getElementById('f-desc').value;
    const cat = document.getElementById('f-cat').value;

    if (!title || !selectedLatLng) return alert("Mangler tittel eller punkt pÃ¥ kartet!");

    steder.push({ title, desc, cat, lat: selectedLatLng.lat, lng: selectedLatLng.lng });
    localStorage.setItem('reise_data', JSON.stringify(steder));
    
    document.getElementById('f-title').value = '';
    document.getElementById('f-desc').value = '';
    toggleModal();
    render();
  }

  function deletePlace(index) {
    if (confirm("Slette dette stedet?")) {
      steder.splice(index, 1);
      localStorage.setItem('reise_data', JSON.stringify(steder));
      render();
    }
  }

  function focusPlace(lat, lng, idx) {
    map.flyTo([lat, lng], 12);
    markers[idx].openPopup();
  }
</script>
</body>
</html>
